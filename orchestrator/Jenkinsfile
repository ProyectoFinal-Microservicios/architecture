/**
 * Jenkinsfile para Notification Orchestrator (Java + Spring Boot)
 * 
 * Pipeline CI/CD:
 * - Checkout del c√≥digo
 * - Compilaci√≥n con Gradle
 * - Pruebas unitarias y Cucumber
 * - Reporte JaCoCo + SonarQube
 * - Construcci√≥n de imagen Docker
 */

pipeline {
    agent any
    
    tools {
        gradle 'Gradle8'
    }

    environment {
        SONARQUBE_ENV = 'sonarqube'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
    }

    stages {
        // ============================================
        // 1Ô∏è‚É£ CHECKOUT
        // ============================================
        stage('üîç Checkout') {
            steps {
                echo "üì• Clonando repositorio..."
                checkout scm
                sh 'git log -1 --pretty=format:"%h - %an: %s" || true'
            }
        }

        // ============================================
        // 2Ô∏è‚É£ BUILD
        // ============================================
        stage('üî® Build') {
            steps {
                echo "üî® Compilando proyecto con Gradle..."
                sh 'java -version'
                sh 'gradle --version'
                sh 'gradle init'
                sh 'gradle clean build --no-daemon'
            }
        }

        // ============================================
        // 3Ô∏è‚É£ PRUEBAS UNITARIAS
        // ============================================
        stage('üß™ Unit Tests') {
            steps {
                echo "üß™ Ejecutando pruebas unitarias..."
                sh './gradlew test --no-daemon --continue || true'
            }
        }

        // ============================================
        // 4Ô∏è‚É£ COBERTURA (JaCoCo)
        // ============================================
        stage('üìä Coverage Report') {
            steps {
                echo "üìä Generando reporte de cobertura con JaCoCo..."
                sh './gradlew jacocoTestReport --no-daemon || true'
            }
        }

        // ============================================
        // 5Ô∏è‚É£ SONARQUBE
        // ============================================
        stage('üîç SonarQube Analysis') {
            steps {
                echo "üîç Analizando c√≥digo con SonarQube..."
                script {
                    if (!fileExists('sonar-project.properties')) {
                        writeFile file: 'sonar-project.properties', text: """
sonar.projectKey=notification-orchestrator
sonar.projectName=Notification Orchestrator
sonar.projectVersion=1.0

# Paths
sonar.sources=src/main/java
sonar.tests=src/test/java
sonar.java.binaries=build/classes/java/main
sonar.java.test.binaries=build/classes/java/test

# Coverage
sonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml

# Exclusions
sonar.exclusions=**/build/**,**/*.gradle,**/gradlew,**/gradlew.bat
sonar.test.inclusions=**/*Test.java,**/*Tests.java

sonar.sourceEncoding=UTF-8
"""
                    }

                    withSonarQubeEnv('SonarQube') {
                        sh """
                            ./gradlew sonarqube \
                                -Dsonar.projectKey=notification-orchestrator \
                                -Dsonar.host.url=${SONAR_HOST_URL} \
                                --no-daemon || true
                        """
                    }
                }
            }
        }

        // Note: Quality Gate, Docker image build and Cucumber stages
        // removed per request. SonarQube analysis remains (no quality gate).
    }

    // ============================================
    // POST BUILD
    // ============================================
    post {

        always {
            echo "üìä Publicando reportes..."
            junit allowEmptyResults: true, testResults: '**/build/test-results/**/*.xml'

            jacoco(
                execPattern: '**/build/jacoco/*.exec',
                classPattern: '**/build/classes/java/main',
                sourcePattern: '**/src/main/java',
                exclusionPattern: '**/*Test*.class'
            )

            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'build/reports/tests/test',
                reportFiles: 'index.html',
                reportName: 'Test Report',
                reportTitles: 'Unit Tests'
            ])
        }

        success {
            echo "‚úÖ Pipeline completado correctamente"
        }

        failure {
            echo "‚ùå Pipeline fall√≥ ‚Äî revisa los logs"
        }

        unstable {
            echo "‚ö†Ô∏è Pipeline inestable ‚Äî algunas pruebas o quality gates fallaron"
        }
    }
}
